package com.wicket_futsal.common;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 *
 * 参考：http://hiro666.sakura.ne.jp/myview.cgi?y=2012&m=02&d=14
 *
 * @author User
 *
 */

public class ResultSetConverter<E> {
    private final Map<String, Method> setters = new HashMap<String, Method>();

    public ResultSetConverter(final ResultSet rs, final Class<E> dtoClass) throws Exception {
        for (String column : getColumns(rs)) {
            try {
                setters.put(column, dtoClass.getMethod(toSetterName(column), new Class[] { String.class }));
            } catch (Exception e) {
                // ignore
            }
        }
    }
    public E toDTO(final ResultSet rs, final E dto) throws SQLException, IllegalArgumentException, IllegalAccessException, InvocationTargetException {
        Object[] parameter = new Object[1];
        for (String column : setters.keySet()) {
            parameter[0] = rs.getString(column);
            setters.get(column).invoke(dto, parameter);
        }
        return dto;
    }
    private static List<String> getColumns(final ResultSet rs) throws SQLException {
        List<String> list = new ArrayList<String>();
        ResultSetMetaData rsMetaData = rs.getMetaData();
        int columnCount = rsMetaData.getColumnCount();
        for (int i = 1; i <= columnCount; i++) {
            list.add(rsMetaData.getColumnName(i));
        }
        return list;
    }
    private static String toSetterName(final String columnName) {
        StringBuilder setterName = new StringBuilder("set");
        for (String part : columnName.split("_")) {
            setterName.append(part.substring(0, 1).toUpperCase());
            setterName.append(part.substring(1).toLowerCase());
        }
        return setterName.toString();
    }
}